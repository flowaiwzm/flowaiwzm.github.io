#### å…³äºFlask+Vueé¡¹ç›®é‡åˆ°çš„é—®é¢˜

---

ä»¥ä¸‹æ˜¯ä½ åœ¨ Flask + Vue é¡¹ç›®å¼€å‘ä¸­æå‡ºçš„ **æ‰€æœ‰é—®é¢˜** åŠå…¶å¯¹åº”çš„ **è§£å†³æ–¹æ¡ˆæ€»ç»“**ï¼Œæ–¹ä¾¿ä½ å¿«é€Ÿå›é¡¾å’ŒæŸ¥é˜…ï¼š

---

### **ğŸ“œ é—®é¢˜æ€»è§ˆ & è§£å†³æ–¹æ¡ˆ**

#### **1. Vue å›¾ç‰‡ä¸Šä¼ ç»„ä»¶é—®é¢˜**
**é—®é¢˜**ï¼š`ImageUpload.vue` ä¸­ `previewUrl.value` èµ‹å€¼é”™è¯¯ï¼ŒæŠ¥é”™ `Cannot create property 'value' on string`
**åŸå› **ï¼šç›´æ¥å¯¹ `ref` å˜é‡èµ‹å€¼ï¼ˆæœªç”¨ `.value`ï¼‰ï¼Œå¯¼è‡´å®ƒå˜æˆæ™®é€šå­—ç¬¦ä¸²ã€‚
**è§£å†³**ï¼š
```javascript
// âœ… æ­£ç¡®å†™æ³•
previewUrl.value = URL.createObjectURL(blob); // å¿…é¡»ç”¨ .value
```

---

#### **2. æ£€æµ‹è®°å½•è‡ªåŠ¨åˆ·æ–°é—®é¢˜**
**éœ€æ±‚**ï¼šä¸Šä¼ å›¾ç‰‡æ£€æµ‹åï¼Œè‡ªåŠ¨åˆ·æ–° `DetectionRecords` ç»„ä»¶ã€‚
**è§£å†³**ï¼š
**æ–¹æ¡ˆ 1ï¼ˆæ¨èï¼‰**ï¼šçˆ¶ç»„ä»¶ç›‘å¬ `image-uploaded` äº‹ä»¶ï¼Œæ‰‹åŠ¨è°ƒç”¨ `fetchRecords`
```javascript
// ImageUpload.vue
emit('image-uploaded', { success: true });

// çˆ¶ç»„ä»¶
<ImageUpload @image-uploaded="recordsRef.fetchRecords()" />
```

**æ–¹æ¡ˆ 2**ï¼šä½¿ç”¨ Pinia å…¨å±€çŠ¶æ€ç®¡ç†
```javascript
// store/upload.js
triggerRefresh() { this.shouldRefresh = true; }

// DetectionRecords.vue
watch(store.shouldRefresh, () => fetchRecords());
```

---

#### **3. æ‘„åƒå¤´æ‹ç…§åŠŸèƒ½é—®é¢˜**
**é—®é¢˜**ï¼šæ‹ç…§åå›¾ç‰‡æ— æ³•æ­£ç¡®æ˜¾ç¤ºæˆ–ä¸Šä¼ ã€‚
**è§£å†³**ï¼š
- æ£€æŸ¥ `canvas.toBlob()` å›è°ƒä¸­æ˜¯å¦æ­£ç¡®ä½¿ç”¨ `ref.value`ã€‚
- ç¡®ä¿ç”Ÿæˆçš„ `File` å¯¹è±¡åŒ…å«æ­£ç¡®çš„ MIME ç±»å‹ï¼š
  ```javascript
  new File([blob], 'capture.jpg', { type: 'image/jpeg' });
  ```

---

#### **4. Flask è·¨åŸŸé—®é¢˜ (CORS)**
**é—®é¢˜**ï¼šVue è®¿é—® Flask API æ—¶å‡ºç°è·¨åŸŸé”™è¯¯ã€‚
**è§£å†³**ï¼š
```python
# Flask åç«¯å®‰è£… flask-cors
from flask_cors import CORS
CORS(app)  # å…è®¸æ‰€æœ‰åŸŸå
# æˆ–ç²¾ç¡®æ§åˆ¶
CORS(app, resources={r"/api/*": {"origins": "http://localhost:5173"}})
```

---

#### **5. å›¾ç‰‡ Base64 ä¼ è¾“é—®é¢˜**
**é—®é¢˜**ï¼šå‰ç«¯æ˜¾ç¤º `processed_image` æ—¶ï¼ŒBase64 æ•°æ®æ ¼å¼é”™è¯¯ã€‚
**è§£å†³**ï¼š
- ç¡®ä¿ Flask è¿”å›çš„ Base64 ä¸å¸¦ `data:image/jpeg;base64,` å‰ç¼€ï¼ˆå‰ç«¯è‡ªè¡Œæ‹¼æ¥ï¼‰ï¼š
  ```vue
  <el-image :src="`data:image/jpeg;base64,${record.processed_image}`" />
  ```

---

#### **6. Axios è¯·æ±‚é”™è¯¯å¤„ç†**
**é—®é¢˜**ï¼šæœªæ•è· API è¯·æ±‚é”™è¯¯ï¼ˆå¦‚ 404/500ï¼‰ã€‚
**è§£å†³**ï¼š
```javascript
try {
  const res = await axios.get('/api/history');
} catch (err) {
  ElMessage.error(err.response?.data?.message || 'è¯·æ±‚å¤±è´¥');
}
```

---

#### **7. Element Plus å›¾æ ‡æœªæ˜¾ç¤º**
**é—®é¢˜**ï¼š`<el-icon>` ä¸æ˜¾ç¤ºå›¾æ ‡ã€‚
**è§£å†³**ï¼š
- ç¡®ä¿å·²æ­£ç¡®å¯¼å…¥å›¾æ ‡ï¼š
  ```javascript
  import { Refresh, Delete } from '@element-plus/icons-vue';
  ```
- æ³¨å†Œä¸ºç»„ä»¶ï¼š
  ```vue
  <el-icon><Refresh /></el-icon>
  ```

---

### **ğŸ“Œ é¡¹ç›®ä¼˜åŒ–å»ºè®®**
1. **çŠ¶æ€ç®¡ç†**ï¼šå¤æ‚æ•°æ®æµå»ºè®®ç”¨ **Pinia**ï¼ˆå¦‚ç”¨æˆ·ç™»å½•çŠ¶æ€ã€å…¨å±€é…ç½®ï¼‰ã€‚
2. **API å±‚å°è£…**ï¼šå°† Axios è¯·æ±‚ç»Ÿä¸€å°è£…ï¼Œç®€åŒ–é”™è¯¯å¤„ç†å’Œ URL ç®¡ç†ã€‚
3. **ç±»å‹å®‰å…¨**ï¼šVue 3 + TypeScript æå‡ä»£ç å¥å£®æ€§ã€‚
4. **æƒé™æ§åˆ¶**ï¼šFlask åç«¯æ·»åŠ  JWT éªŒè¯ï¼ˆå¦‚ `flask-jwt-extended`ï¼‰ã€‚

``````vue
<template>
  <el-container class="home-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <el-header class="header">
      <div class="header-content">
        <h1>æ£®æ—ç«ç¾çƒŸé›¾æ£€æµ‹ç³»ç»Ÿ</h1>
        <!-- æ¡Œé¢ç«¯æŒ‰é’®å¸ƒå±€ -->
        <div class="header-buttons desktop-buttons">
          <el-button type="info" plain @click="goToWiki">
            <i class="el-icon-notebook-2"></i> ç«ç¾çƒŸé›¾ç™¾ç§‘
          </el-button>
          <el-button type="primary" plain @click="goToPerson">
            <i class="el-icon-user"></i> ä¸ªäººä¿¡æ¯
          </el-button>
          <el-button type="danger" @click="logout">
            <i class="el-icon-switch-button"></i> é€€å‡ºç™»å½•
          </el-button>
        </div>
      </div>
    </el-header>

    <!-- ä¸»å†…å®¹åŒº -->
    <el-main class="main-content">
      <div class="horizontal-layout">
        <!-- ä¸Šä¼ æ¨¡å— -->
        <el-card class="panel-card upload-panel">
          <template #header>
            <div class="panel-title">
              <i class="el-icon-upload"></i> å›¾ç‰‡ä¸Šä¼ 
            </div>
          </template>
          <ImageUpload  @clear-results="handleClearResults"
		   @image-uploaded="handleImageUploaded" 
		   @start-processing="(val) => resultLoading = val"
          :selected-model="selectedModel"  
          :confidence-threshold="confidenceThreshold"
          :iou-threshold="iouThreshold"
/>
        </el-card>
        <!-- ç»“æœæ¨¡å— -->
        <el-card  class="panel-card result-panel">
          <template #header>
            <div class="panel-title">
              <i class="el-icon-document"></i> æ£€æµ‹ç»“æœ
            </div>
          </template>
          <ResultDisplay :result="result" />
        </el-card>
        <!-- æ£€æµ‹è®°å½• -->
        <el-card v-show="!isMobile" class="panel-card records-panel">
          <template #header>
            <div class="panel-title">
              <i class="el-icon-collection"></i> æ£€æµ‹è®°å½•
            </div>
          </template>
          <DetectionRecords 
            :records="records || []"  
            @refresh="fetchDetectionRecords"

          />
        </el-card>
        <!-- æ­¥éª¤æ¨¡å— -->
        <el-card v-show="!isMobile" class="panel-card steps-panel">
          <template #header>
            <div class="panel-title">
              <i class="el-icon-guide"></i> è¯Šæ–­æ­¥éª¤
            </div>
          </template>
          <DiagnosisSteps />
        </el-card>      
      </div>
    </el-main>

    <el-footer class="footer">
      <el-card class="footer-card">
        <template #header>
          <div class="footer-title">
            <i class="el-icon-data-line"></i>
            <span>æ¨¡å‹å‚æ•°è°ƒèŠ‚</span>
          </div>
        </template>
        <div class="model-controls">
          <el-form label-position="left" label-width="120px">
            <el-form-item label="é€‰æ‹©æ£€æµ‹æ¨¡å‹">
              <el-select
                v-model="selectedModel"
                placeholder="è¯·é€‰æ‹©æ¨¡å‹"
                @change="updateModel"
                style="width: 100%"
              >
                <el-option
                  v-for="model in modelList"
                  :key="model"
                  :label="model"
                  :value="model"
                />
              </el-select>
            </el-form-item>
            
            <el-form-item label="ç½®ä¿¡åº¦é˜ˆå€¼">
              <el-slider
                v-model.number="confidenceThreshold"
                :min="0"
                :max="1"
                :step="0.01"
                show-input
                @change="updateParameters"
              />
            </el-form-item>
            
            <el-form-item label="IOUé˜ˆå€¼">
              <el-slider
                v-model.number="iouThreshold"
                :min="0"
                :max="1"
                :step="0.01"
                show-input
                @change="updateParameters"
              />
            </el-form-item>
          </el-form>
        </div>
      </el-card>
  </el-footer>
  <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ  -->
      <div v-show="isMobile" class="mobile-nav">
        <el-button type="info" plain @click="goToWiki">
          <i class="el-icon-notebook-2"></i> ç™¾ç§‘
        </el-button>
        <el-button type="primary" plain @click="goToPerson">
          <i class="el-icon-user"></i> ä¸ªäºº
        </el-button>
        <el-button type="danger" @click="logout">
          <i class="el-icon-switch-button"></i> é€€å‡º
        </el-button>
      </div>
  </el-container>
</template>

<script setup>
import { ref, onMounted, onUnmounted ,computed} from 'vue';
import { useRouter } from 'vue-router';
import ImageUpload from '@/components/ImageUpload.vue';
import ResultDisplay from '@/components/ResultDisplay.vue';
import DiagnosisSteps from '@/components/DiagnosisSteps.vue';
import { ElMessage } from 'element-plus'
import DetectionRecords from '@/components/DetectionRecords.vue'
import axios from 'axios'
const modelList = ref([])
const selectedModel = ref('')
const confidenceThreshold = ref(0.5)
const iouThreshold = ref(0.45)
const router = useRouter();
const result = ref({
  originalImage: '',
  processedImage: '',
  results: { counts: {}, detections: [] },
  meta: {}
});
const resultLoading = ref(false);
const records = ref([]);
const windowWidth = ref(window.innerWidth);
// æ–°å¢ï¼šç§»åŠ¨ç«¯æ£€æµ‹
const isMobile = computed(() => windowWidth.value < 992);
// è¯·æ±‚æ§åˆ¶ç›¸å…³
const currentRequestSource = ref(null) // ç”¨äºå–æ¶ˆè¯·æ±‚çš„CancelTokenSource
let activeRequestId = 0 // å½“å‰æ´»è·ƒè¯·æ±‚ID
const handleResize = () => {
  windowWidth.value = window.innerWidth;
};
onMounted(() => {
  fetchModels()
  fetchDetectionRecords();
  window.addEventListener('resize', handleResize)
});
onUnmounted(() => {
  window.removeEventListener('resize', handleResize);
  cancelCurrentRequest(); // ç»„ä»¶å¸è½½æ—¶å–æ¶ˆè¯·æ±‚
});
const fetchModels = async () => {
  try {
    const response = await axios.get('/api/models')
    modelList.value = response.data.data.models
    if (modelList.value.length > 0) {
      selectedModel.value = modelList.value[0]
    }
  } catch (error) {
    ElMessage.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥')
  }
}
const fetchDetectionRecords = async () => {
  try {
    const response = await axios.get('/api/detection_records');
    records.value = response.data.records;
  } catch (error) {
    ElMessage.error('è·å–æ£€æµ‹è®°å½•å¤±è´¥');
  }
};
const updateParameters = () => {
  ElMessage.success('å‚æ•°æ›´æ–°æˆåŠŸ');
}
const updateModel = () => {
  ElMessage.success(`å·²åˆ‡æ¢è‡³æ¨¡å‹: ${selectedModel.value}`);
}
const goToWiki = () => {
  router.push('/wiki');
};
const handleClearResults = () => {
  // æ¸…ç©ºç»“æœæ—¶é‡Šæ”¾Blob URL
  if (result.value.originalImage?.startsWith('blob:')) {
    URL.revokeObjectURL(result.value.originalImage)
  }
  
  result.value = {
    originalImage: '',
    processedImage: '',
    results: { counts: {}, detections: [] },
    meta: {}
  }
}
// å–æ¶ˆå½“å‰è¯·æ±‚
const cancelCurrentRequest = () => {
  if (currentRequestSource.value) {
    currentRequestSource.value.cancel('è¯·æ±‚è¢«å–æ¶ˆ')
    currentRequestSource.value = null
  }
}
const handleImageUploaded = async (newResult) => {
  handleClearResults();
  if (!newResult?.rawFile) {
    ElMessage.error('æ— æ•ˆçš„æ–‡ä»¶å¯¹è±¡');
    return;
  }
  try {
    // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
    cancelCurrentRequest()
    
    // åˆ›å»ºæ–°çš„å–æ¶ˆä»¤ç‰Œ
    const source = axios.CancelToken.source()
    currentRequestSource.value = source
    
    // ç”Ÿæˆå”¯ä¸€è¯·æ±‚ID
    const requestId = ++activeRequestId
    resultLoading.value = true;
    
    const formData = new FormData();
    formData.append('image', newResult.rawFile);
    formData.append('model', selectedModel.value);
    formData.append('confidence', confidenceThreshold.value.toString());
    formData.append('iou', iouThreshold.value.toString());
	const config = {
		  headers: { 
			'Content-Type': 'multipart/form-data',
			'X-File-Key': newResult.fileKey || Date.now()
		  },
		  cancelToken: source.token
		};
    const response = await axios.post('/api/predict', formData, config);
    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ€æ–°è¯·æ±‚
    if (requestId !== activeRequestId) {
      console.log('å¿½ç•¥è¿‡æœŸè¯·æ±‚çš„å“åº”')
      return
    }
    // é‡Šæ”¾ä¹‹å‰çš„Blob URL
    if (result.value.originalImage?.startsWith('blob:')) {
      URL.revokeObjectURL(result.value.originalImage)
    }
    // æ›´æ–°ç»“æœ
    result.value = {
      originalImage: URL.createObjectURL(newResult.rawFile),
      processedImage: response.data.data?.image || '',
      results: {
        counts: { ...(response.data.data?.results?.counts || {}) },
        detections: [...(response.data.data?.results?.detections || [])]
      },
      meta: {
        model: selectedModel.value,
        confidence: confidenceThreshold.value,
        iou: iouThreshold.value,
        timestamp: Date.now()
      }
    };
    ElMessage.success("æ£€æµ‹æˆåŠŸ");
  } catch (error) {
    if (!axios.isCancel(error)) {
      console.error('æ£€æµ‹é”™è¯¯:', error);
      ElMessage.error(`æ£€æµ‹å¤±è´¥: ${error.response?.data?.message || error.message}`);
    }
  } finally {
    resultLoading.value = false;
    currentRequestSource.value = null
  }
};
const goToPerson = () => {
  router.push('/person');
};
const logout = () => {
  localStorage.removeItem('token');
  localStorage.removeItem('user_id');
  router.push('/login');
};
</script>


<style scoped>
    .home-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(rgba(245, 245, 245, 0.9), rgba(245, 245, 245, 0.9)),
                  url('../assets/images/2.jpg') no-repeat center center;
      background-size: cover;
    }

    /* å¤´éƒ¨æ ·å¼ */
    .header {
      height: 80px;
      background-color: #1a2935;
      color: white;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	  padding: 0 10px;
    }

    .header-content {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
	  flex-wrap: wrap;
    }

    .header h1 {
        margin: 10px;
        font-size: clamp(16px, 3vw, 24px);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 50%;
    }
	.header-buttons{
		display: flex;
		flex-wrap: wrap;
		justify-content: flex-end;
		text-overflow: ellipsis;
		gap:8px;
	}
    .header-buttons .el-button {
      margin-left: 5px;
    }
    /* éšè—æ¡Œé¢æŒ‰é’®åœ¨ç§»åŠ¨ç«¯ */
.desktop-buttons {
  display: flex;
}
@media (max-width: 992px) {
    .desktop-buttons {
      display: none;
    }
  }
  .header-buttons .el-button {
    margin-left: 5px;
  }

    /* ä¸»å†…å®¹åŒºæ ·å¼ */
    .main-content {
      flex: 1;
      padding: 10px;
      overflow: auto;
      display:flex;
    }
    .horizontal-layout {
      display: grid;
      grid-template-columns: 0.8fr 0.8fr 0.8fr 0.3fr; /* ä¸‰åˆ—ç­‰å®½ */ 
      /* grid-template-columns:repeat(4,1fr); */
	  /* grid-template-rows: repeat(2,minmax(200px,1fr)); */
	    gap: 8px;
      width: 100%;
      height: 100%;
    }
    /* ç§»åŠ¨ç«¯å¸ƒå±€ */
    @media (max-width: 992px) {
      .horizontal-layout {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .panel-card {
        min-height: auto;
        max-height: none;
      }
      
      .records-panel,
      .steps-panel {
        display: none;
      }
    }
    .panel-card {
      height: 100%;
      border-radius: 10px;
      display: flex;
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
      flex-direction: column;
      min-width: 0;
    }
    .panel-card :deep(.el-card__body) {
      flex: 1;
      overflow: auto;
      padding: 10px;
    }
    .panel-title {
      font-size: 16px;
      font-weight: 500;
      display: flex;
      align-items: center;
    }
    .panel-title i {
      margin-right: 8px;
    }


    /* å¡ç‰‡æ ·å¼ */
    .upload-card,
    .result-card,
    .steps-card {
      height: 100%;
      overflow: hidden; /* ä»…å†…éƒ¨æ»šåŠ¨ */
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }
    /* å„é¢æ¿å†…å®¹ç‰¹å®šé«˜åº¦æ§åˆ¶ */
    .upload-panel :deep(.upload-area) {
		overflow: hidden;
      height: calc(100% - 40px);
    }
    .result-panel :deep(.result-content) {
      height: 100%;
    }
    .steps-panel :deep(.steps-container) {
      height: 100%;
    }
    /* å“åº”å¼å¤„ç† */
    @media (max-width: 1200px) {
      .horizontal-layout {
        grid-template-columns: 0.5fr 1fr 1fr; /* ä¸Šä¼ åŒºåŸŸç¨å®½ */
      }
    }
    @media (max-width: 992px) {
      .horizontal-layout {
        grid-template-columns: 1fr; /* çª„å±æ—¶å‚ç›´å †å  */
        grid-auto-rows: auto;
      }
      .panel-card {
        min-height: 300px; /* ä¿æŒæœ€ä½é«˜åº¦ */
      }
    }

    .footer {
      height: auto;
      padding: 0;
    }
    .footer-card {
      height: 100%;
      border-radius: 0;
      border-left: none;
      border-right: none;
      border-bottom: none;
    }
    .footer-title {
      display: flex;
      align-items: center;
      font-size: 16px;
      font-weight: 500;
    }
    .footer-title i {
      margin-right: 8px;
      font-size: 18px;
    }


    .chart-container {
      height: calc(100% - 40px);
      padding: 10px;
    }
	/* ç§»åŠ¨ç«¯å¯¼èˆªæ  */
    .mobile-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 8px;
      background-color: #fff;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    .mobile-nav .el-button {
      flex: 1;
      margin: 0 4px;
      padding: 8px;
      font-size: 12px;
    }
</style>

``````



